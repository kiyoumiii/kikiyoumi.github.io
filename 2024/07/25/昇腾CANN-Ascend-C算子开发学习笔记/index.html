<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="author" content="kiyoumiii"/><meta name="description" content="kiyoumiii's blog"/><meta name="keyword"/><title>昇腾CANN-Ascend C算子开发学习笔记 - MEOW - kiyoumi's blog</title><link rel="shortcut icon" href="/img/site-icon.png">
<link rel="stylesheet" href="/css/style.css">


<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
<meta name="generator" content="Hexo 7.3.0"></head><body><header><div class="top-nav" ondblclick="scrollToTop()"><div class="nav-info"><div class="nav-icon"><img id="nav-icon" src="/img/site-icon.png"/></div><div class="nav-title"><a id="nav-title" href="/" title="主页">Hexo</a></div></div><div class="nav-ribbon"><div class="top-menu-expanded"><a class="top-menu-item" href="/archives"><span>归档</span></a><a class="top-menu-item" href="/categories"><span>分类</span></a><a class="top-menu-item" href="/tags"><span>标签</span></a><a class="top-menu-item" href="/about"><span>关于</span></a></div><div class="top-search" onclick="toggleSearchWindow()"><div id="top-search-btn" title="搜索"><i class="icon fa-solid fa-magnifying-glass"></i><span>搜索</span></div></div><div id="top-menu-btn" onclick="openTopMenu()" title="打开菜单"><i class="fa-solid fa-bars fa-lg"></i></div></div></div></header><div id="top-menu-hidden"><div class="menu-hidden-content"><div class="menu-hidden-nav"><a class="menu-hidden-item" href="/archives"><i class="fa-solid fa-box-archive fa-sm"></i><span>归档</span></a><a class="menu-hidden-item" href="/categories"><i class="fa-regular fa-folder-open fa-sm"></i><span>分类</span></a><a class="menu-hidden-item" href="/tags"><i class="fa-solid fa-tags fa-sm"></i><span>标签</span></a><a class="menu-hidden-item" href="/about"><i class="fa-solid fa-paw fa-sm"></i><span>关于</span></a></div></div><div class="menu-hidden-blank" onclick="closeTopMenu()"></div></div>
<div class="blog-info"><div class="blog-pic"><img id="blog-pic" src="/img/site-icon.png"/></div><div class="blog-title"><i class="fa-solid fa-paw fa-2xs fa-rotate-by"></i><span>MEOW</span><i class="fa-solid fa-paw fa-2xs fa-rotate-by"></i></div><div class="blog-desc">个人小站，记录学习点滴，欢迎访问~</div></div><div class="main"><div class="main-content"><article class="post"><div class="post-title"><h1><i class="fa-solid fa-paw"></i>昇腾CANN-Ascend C算子开发学习笔记</h1></div><div class="post-info"><div class="post-info-first-line"><div class="post-date"><i class="icon fa-regular fa-calendar-plus" title="发布日期"></i><time class="publish-time">2024-07-25</time><i class="icon fa-regular fa-calendar-check" title="更新日期"></i><time class="update-time">2024-07-25</time></div>

</div><div class="post-info-second-line"><div class="post-copyright"><i class="icon fa-brands fa-creative-commons" title="版权声明"></i><span>版权声明: </span><a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh-hans" title="CC BY-NC-ND 4.0">署名-非商业性使用-禁止演绎 4.0</a></div>
<div class="post-word-count"><i class="icon fa-solid fa-pen-to-square"></i><span>全文约1926字</span></div><div class="pageview-post"><i class="icon fa-regular fa-eye"></i><span id="busuanzi_container_page_pv">本文阅读次数: <span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner"></i></span></span></div></div></div><div class="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>此为华为昇腾AI训练营（南京站）授课内容，经个人整理发布</p>
<p>为了更好的理解课程内容，建议读者有一定的计算机组成原理、编译原理学习基础</p>
<p>本文在笔者CSDN账号先行发布，后同步到此，因此图片水印皆为笔者本人CSDN账号水印</p>
<h1 id="一、背景知识"><a href="#一、背景知识" class="headerlink" title="一、背景知识"></a>一、背景知识</h1><h2 id="1-CANN-AI-core"><a href="#1-CANN-AI-core" class="headerlink" title="1. CANN&amp;AI core"></a>1. CANN&amp;AI core</h2><div align=center>
    <img src="https://i-blog.csdnimg.cn/direct/959d581b757747989d8e39ed91e96fae.jpeg">
</div>

<p>1.华为的异构计算架构CANN（Compute Architecture for Neural Networks）对标NVIDA的CUDA<br><br>2.NPU（Neural Processing Unit）架构是一种新型的处理器设计理念，它将传统的CPU和GPU架构进行整合，并引入了深度学习算法。<br><br>3.AI core 采用华为自研的达芬奇架构，它包含下面几个组成部分：<br></p>
<ul>
<li>计算单元（矩阵计算、向量计算、标量计算） </li>
<li>存储系统 </li>
<li>控制单元</li>
</ul>
<p>Ascend C编程语言开发的算子运行在AI core上</p>
<h2 id="2-Ascend-C算子"><a href="#2-Ascend-C算子" class="headerlink" title="2. Ascend C算子"></a>2. Ascend C算子</h2><ul>
<li><p>算子：一个函数空间到函数空间上的映射</p>
</li>
<li><p>从广义上讲，对任何函数进行某一项操作都可以认为是一个算子</p>
</li>
<li><p>CUDA与CANN的算子不通用</p>
</li>
</ul>
<h2 id="3-核函数"><a href="#3-核函数" class="headerlink" title="3. 核函数"></a>3. 核函数</h2><ul>
<li>核函数：Ascend C算子设备侧的入口</li>
<li>核函数是直接在设备侧执行的代码</li>
<li>使用变量类型限定符</li>
<li>核函数必须具有void返回类型</li>
<li>核函数的调用语句是C&#x2F;C++函数调用语句的一种扩展</li>
</ul>
<h1 id="二、编程范式"><a href="#二、编程范式" class="headerlink" title="二、编程范式"></a>二、编程范式</h1><p>Ascend C采用标准C++语法和一组类库API进行编程</p>
<p>1）矢量编程主要分为：</p>
<ul>
<li>CopyIn </li>
<li>Compute </li>
<li>CopyOut</li>
</ul>
<p>3个流水任务：CopyIn负责搬入操作，Compute负责矢量计算操作，CopyOut负责搬出操作</p>
<p>2）矩阵编程主要分为：</p>
<ul>
<li>CopyIn</li>
<li>Split</li>
<li>Compute</li>
<li>Aggregate</li>
<li>CopyOut</li>
</ul>
<p>相比矢量编程多了矩阵分割（Split）和聚合（Aggregate）两步</p>
<h1 id="三、香橙派的连接"><a href="#三、香橙派的连接" class="headerlink" title="三、香橙派的连接"></a>三、香橙派的连接</h1><p>文档：<a target="_blank" rel="noopener" href="https://www.hiascend.com/document/detail/zh/Atlas200IDKA2DeveloperKit/23.0.RC2/qs/qs_0017.html">Orange pai连接及操作实验文档</a></p>
<h1 id="四、改造sinh任务"><a href="#四、改造sinh任务" class="headerlink" title="四、改造sinh任务"></a>四、改造sinh任务</h1><p>首先运动add任务，然后修改add算子功能为sinh函数功能</p>
<h2 id="1-测试运行"><a href="#1-测试运行" class="headerlink" title="1.测试运行"></a>1.测试运行</h2><p>根据实验手册，成功运行后会显示：test pass</p>
<div align=center>
    <img src="https://i-blog.csdnimg.cn/direct/3f611475c7504a4a888b70c4934fd5d1.jpeg">
</div>


<h2 id="2-改造成sinh"><a href="#2-改造成sinh" class="headerlink" title="2.改造成sinh"></a>2.改造成sinh</h2><div align=center>
    <img src="https://img-blog.csdnimg.cn/img_convert/f7aa26cc2b49cc5c825e95f01d321dad.png">
</div>


<p>需要参考一些官方的API：<br><a href="https://link.csdn.net/?target=https://www.hiascend.com/zh/developer/courses/detail/1696414606799486977">华为昇腾社区-Ascend C</a></p>
<p>需要修改目录：<code>~/samples/operator/AddCustomSample/KernelLaunch/test</code><br>下的两个文档：</p>
<ul>
<li>add_custom.cpp</li>
<li>scripts &#x2F; gen_data.py</li>
</ul>
<p>分别需要修改的地方为：</p>
<ul>
<li>1</li>
</ul>
<div align=center>
    <img src="https://img-blog.csdnimg.cn/img_convert/55a966993b663a71b8d7feadf8c7fbf3.png">
</div>


<ul>
<li>2</li>
</ul>
<div align=center>
    <img src="https://img-blog.csdnimg.cn/img_convert/e0ddb5c183803561c5c3588e45e492d0.png">
</div>


<p>将公式修改为sinh的公式，之后用实验文档中的运行命令再次运行即可</p>
<h1 id="五、Ascend-C中级认证"><a href="#五、Ascend-C中级认证" class="headerlink" title="五、Ascend C中级认证"></a>五、Ascend C中级认证</h1><p><a target="_blank" rel="noopener" href="https://www.hiascend.com/edu/certification/detail/34bf904cb410497cb9c582be6c047ff7"><strong>点击链接：Ascend C中级认证考试</strong></a></p>
<p>题目：<br><em><strong>参考tensorflow的Sinh算子，实现Ascend C算子Sinh，算子命名为SinhCustom，并完成aclnn算子调用相关算法: sinh(x) &#x3D; (exp(x) - exp(-x)) &#x2F; 2.0<br>要求:<br>1、完成host侧和kernel侧代码实现。<br>2、实现sinh功能，支持float16类型输入，使用内核调试符方式调用算子测试通过。<br>3、使用单算子API调用方式调用SinhCustom算子测试通过<br>提交要求:<br>完成编程后，将上述实现的工程代码打包在rar包内提交，如SinhCustom.rar.</strong></em></p>
<p>所有需要补充的文件包括：</p>
<ul>
<li>op_host文件夹下的sinh_custom_tiling.h文件</li>
<li>op_host文件夹下的sinh_custom.cpp文件</li>
<li>op_kernel文件夹下的sinh_custom.cpp文件</li>
</ul>
<p>这个实现过程可以参考samples仓库的Add算子，把Add算子的内核调用代码复制一份到SinhCustom，Add需要x，y，z三个变量，sinh只需x和y两个变量，因此删掉关于z的操作</p>
<ol>
<li>kernel侧的sinh_custom.cpp文件内关键公式修改方法参考前文所示，完整代码如下：</li>
</ol>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel_operator.h&quot;</span></span></span><br><span class="line">using namespace AscendC;</span><br><span class="line"><span class="type">constexpr</span> <span class="type">int32_t</span> BUFFER_NUM = <span class="number">2</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KernelSinh</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line"> __aicore__ <span class="keyword">inline</span> <span class="title function_">KernelSinh</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"> __aicore__ <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">Init</span><span class="params">(GM_ADDR x, GM_ADDR y, <span class="type">uint32_t</span> totalLength, <span class="type">uint32_t</span> </span></span><br><span class="line"><span class="params">tileNum)</span></span><br><span class="line"> &#123;</span><br><span class="line"> <span class="comment">//考生补充初始化代码</span></span><br><span class="line"> ASSERT(GetBlockNum() != <span class="number">0</span> &amp;&amp; <span class="string">&quot;block dim can not be zero!&quot;</span>);</span><br><span class="line"> this-&gt;blockLength = totalLength / GetBlockNum();</span><br><span class="line"> this-&gt;tileNum = tileNum;</span><br><span class="line"> ASSERT(tileNum != <span class="number">0</span> &amp;&amp; <span class="string">&quot;tile num can not be zero!&quot;</span>);</span><br><span class="line"> this-&gt;tileLength = this-&gt;blockLength / tileNum / BUFFER_NUM;</span><br><span class="line"> xGm.SetGlobalBuffer((__gm__ DTYPE_X *)x + this-&gt;blockLength * GetBlockIdx(), </span><br><span class="line">this-&gt;blockLength);</span><br><span class="line"> yGm.SetGlobalBuffer((__gm__ DTYPE_Y *)y + this-&gt;blockLength * GetBlockIdx(), </span><br><span class="line">this-&gt;blockLength);</span><br><span class="line"> pipe.InitBuffer(inQueueX, BUFFER_NUM, this-&gt;tileLength * <span class="keyword">sizeof</span>(DTYPE_X));</span><br><span class="line"> pipe.InitBuffer(outQueueY, BUFFER_NUM, this-&gt;tileLength * <span class="keyword">sizeof</span>(DTYPE_Y));</span><br><span class="line"> pipe.InitBuffer(tmpBuffer1, this-&gt;tileLength * <span class="keyword">sizeof</span>(DTYPE_X));</span><br><span class="line"> pipe.InitBuffer(tmpBuffer2, this-&gt;tileLength * <span class="keyword">sizeof</span>(DTYPE_X));</span><br><span class="line"> pipe.InitBuffer(tmpBuffer3, this-&gt;tileLength * <span class="keyword">sizeof</span>(DTYPE_X));</span><br><span class="line"> pipe.InitBuffer(tmpBuffer4, this-&gt;tileLength * <span class="keyword">sizeof</span>(DTYPE_X));</span><br><span class="line"> &#125;</span><br><span class="line"> __aicore__ <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">Process</span><span class="params">()</span></span><br><span class="line"> &#123;</span><br><span class="line"> <span class="comment">//考生补充对“loopCount”的定义，注意对 Tiling 的处理</span></span><br><span class="line"> <span class="type">int32_t</span> loopCount = this-&gt;tileNum * BUFFER_NUM;</span><br><span class="line"> <span class="keyword">for</span> (<span class="type">int32_t</span> i = <span class="number">0</span>; i &lt; loopCount; i++) &#123;</span><br><span class="line"> CopyIn(i);</span><br><span class="line"> Compute(i);</span><br><span class="line"> CopyOut(i);</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line">private:</span><br><span class="line"> __aicore__ <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">CopyIn</span><span class="params">(<span class="type">int32_t</span> progress)</span></span><br><span class="line"> &#123;</span><br><span class="line"> <span class="comment">//考生补充算子代码</span></span><br><span class="line"> LocalTensor&lt;DTYPE_X&gt; xLocal = inQueueX.AllocTensor&lt;DTYPE_X&gt;();</span><br><span class="line"> DataCopy(xLocal, xGm[progress * this-&gt;tileLength], this-&gt;tileLength);</span><br><span class="line"> inQueueX.EnQue(xLocal);</span><br><span class="line"> &#125;</span><br><span class="line"> __aicore__ <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">Compute</span><span class="params">(<span class="type">int32_t</span> progress)</span></span><br><span class="line"> &#123;</span><br><span class="line"> <span class="comment">//考生补充算子计算代码</span></span><br><span class="line"> LocalTensor&lt;DTYPE_X&gt; xLocal = inQueueX.DeQue&lt;DTYPE_X&gt;();</span><br><span class="line"> LocalTensor&lt;DTYPE_Y&gt; yLocal = outQueueY.AllocTensor&lt;DTYPE_Y&gt;();</span><br><span class="line"> LocalTensor&lt;DTYPE_X&gt; tmpTensor1 = tmpBuffer1.Get&lt;DTYPE_X&gt;();</span><br><span class="line"> LocalTensor&lt;DTYPE_X&gt; tmpTensor2 = tmpBuffer2.Get&lt;DTYPE_X&gt;();</span><br><span class="line"> LocalTensor&lt;DTYPE_X&gt; tmpTensor3 = tmpBuffer3.Get&lt;DTYPE_X&gt;();</span><br><span class="line"> LocalTensor&lt;DTYPE_X&gt; tmpTensor4 = tmpBuffer4.Get&lt;DTYPE_X&gt;();</span><br><span class="line"> DTYPE_X inputVal1 = <span class="number">-1</span>;</span><br><span class="line"> DTYPE_X inputVal2 = <span class="number">0.5</span>;</span><br><span class="line"> <span class="comment">//sinh(x) = (exp(x) - exp(-x)) / 2.0</span></span><br><span class="line"> Muls(tmpTensor1, xLocal, inputVal1, this-&gt;tileLength);</span><br><span class="line"> Exp(tmpTensor2, tmpTensor1, this-&gt;tileLength);</span><br><span class="line"> Exp(tmpTensor3, xLocal, this-&gt;tileLength);</span><br><span class="line"> Sub(tmpTensor4, tmpTensor3, tmpTensor2, this-&gt;tileLength);</span><br><span class="line"> Muls(yLocal, tmpTensor4, inputVal2, this-&gt;tileLength);</span><br><span class="line"> outQueueY.EnQue&lt;DTYPE_Y&gt;(yLocal);</span><br><span class="line"> inQueueX.FreeTensor(xLocal);</span><br><span class="line"> &#125;</span><br><span class="line"> __aicore__ <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">CopyOut</span><span class="params">(<span class="type">int32_t</span> progress)</span></span><br><span class="line"> &#123;</span><br><span class="line"> <span class="comment">//考生补充算子代码</span></span><br><span class="line"> LocalTensor&lt;DTYPE_Y&gt; yLocal = outQueueY.DeQue&lt;DTYPE_Y&gt;();</span><br><span class="line"> DataCopy(yGm[progress * this-&gt;tileLength], yLocal, this-&gt;tileLength);</span><br><span class="line"> outQueueY.FreeTensor(yLocal);</span><br><span class="line"> &#125;</span><br><span class="line">private:</span><br><span class="line"> TPipe pipe;</span><br><span class="line"> <span class="comment">//create queue for input, in this case depth is equal to buffer num</span></span><br><span class="line"> TQue&lt;QuePosition::VECIN, BUFFER_NUM&gt; inQueueX;</span><br><span class="line"> <span class="comment">//create queue for output, in this case depth is equal to buffer num</span></span><br><span class="line"> TQue&lt;QuePosition::VECOUT, BUFFER_NUM&gt; outQueueY;</span><br><span class="line"> GlobalTensor&lt;half&gt; xGm;</span><br><span class="line"> GlobalTensor&lt;half&gt; yGm;</span><br><span class="line"> <span class="comment">//考生补充自定义成员变量</span></span><br><span class="line"> TBuf&lt;QuePosition::VECCALC&gt; tmpBuffer1, tmpBuffer2, tmpBuffer3, tmpBuffer4;</span><br><span class="line"> <span class="type">uint32_t</span> blockLength;</span><br><span class="line"> <span class="type">uint32_t</span> tileNum;</span><br><span class="line"> <span class="type">uint32_t</span> tileLength;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> __global__ __aicore__ <span class="type">void</span> <span class="title function_">sinh_custom</span><span class="params">(GM_ADDR x, GM_ADDR y, GM_ADDR </span></span><br><span class="line"><span class="params">workspace, GM_ADDR tiling)</span> &#123;</span><br><span class="line"> GET_TILING_DATA(tiling_data, tiling);</span><br><span class="line"> KernelSinh op;</span><br><span class="line"> <span class="comment">//补充 init 和 process 函数调用内容</span></span><br><span class="line"> op.Init(x, y, tiling_data.totalLength, tiling_data.tileNum);</span><br><span class="line"> op.Process();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>host侧的tiling.h文件：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;register/tilingdata_base.h&quot;</span></span></span><br><span class="line">namespace optiling &#123;</span><br><span class="line">BEGIN_TILING_DATA_DEF(SinhCustomTilingData)</span><br><span class="line"> <span class="comment">//考生自行定义 tiling 结构体成员变量</span></span><br><span class="line">TILING_DATA_FIELD_DEF(<span class="type">uint32_t</span>, totalLength);</span><br><span class="line">TILING_DATA_FIELD_DEF(<span class="type">uint32_t</span>, tileNum);</span><br><span class="line">END_TILING_DATA_DEF;</span><br><span class="line">REGISTER_TILING_DATA_CLASS(SinhCustom, SinhCustomTilingData)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>host侧的sinh_custom.cpp文件：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sinh_custom_tiling.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;register/op_def_registry.h&quot;</span></span></span><br><span class="line">namespace optiling &#123;</span><br><span class="line"><span class="type">static</span> ge::graphStatus <span class="title function_">TilingFunc</span><span class="params">(gert::TilingContext* context)</span></span><br><span class="line">&#123;</span><br><span class="line"> SinhCustomTilingData tiling;</span><br><span class="line"> <span class="comment">//考生自行填充</span></span><br><span class="line"> <span class="type">const</span> <span class="type">uint32_t</span> BLOCK_DIM = <span class="number">8</span>;</span><br><span class="line"> <span class="type">const</span> <span class="type">uint32_t</span> TILE_NUM = <span class="number">8</span>;</span><br><span class="line"> <span class="type">uint32_t</span> totalLength = context-&gt;GetInputShape(<span class="number">0</span>)-&gt;GetOriginShape().GetShapeSize();</span><br><span class="line"> context-&gt;SetBlockDim(BLOCK_DIM);</span><br><span class="line"> tiling.set_totalLength(totalLength);</span><br><span class="line"> tiling.set_tileNum(TILE_NUM);</span><br><span class="line"> tiling.SaveToBuffer(context-&gt;GetRawTilingData()-&gt;GetData(), </span><br><span class="line">context-&gt;GetRawTilingData()-&gt;GetCapacity());</span><br><span class="line"> context-&gt;GetRawTilingData()-&gt;SetDataSize(tiling.GetDataSize());</span><br><span class="line"> <span class="type">size_t</span> *currentWorkspace = context-&gt;GetWorkspaceSizes(<span class="number">1</span>);</span><br><span class="line"> currentWorkspace[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"> <span class="keyword">return</span> ge::GRAPH_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace ge &#123;</span><br><span class="line"><span class="type">static</span> ge::graphStatus <span class="title function_">InferShape</span><span class="params">(gert::InferShapeContext* context)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">const</span> gert::Shape* x1_shape = context-&gt;GetInputShape(<span class="number">0</span>);</span><br><span class="line"> gert::Shape* y_shape = context-&gt;GetOutputShape(<span class="number">0</span>);</span><br><span class="line"> *y_shape = *x1_shape;</span><br><span class="line"> <span class="keyword">return</span> GRAPH_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace ops &#123;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SinhCustom</span> :</span> public OpDef &#123;</span><br><span class="line">public:</span><br><span class="line"> explicit <span class="title function_">SinhCustom</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* name)</span> : <span class="title function_">OpDef</span><span class="params">(name)</span></span><br><span class="line"> &#123;</span><br><span class="line"> this-&gt;Input(<span class="string">&quot;x&quot;</span>)</span><br><span class="line"> .ParamType(REQUIRED)</span><br><span class="line"> .DataType(&#123;ge::DT_FLOAT16&#125;)</span><br><span class="line"> .Format(&#123;ge::FORMAT_ND&#125;)</span><br><span class="line"> .UnknownShapeFormat(&#123;ge::FORMAT_ND&#125;);</span><br><span class="line"> this-&gt;Output(<span class="string">&quot;y&quot;</span>)</span><br><span class="line"> .ParamType(REQUIRED)</span><br><span class="line"> .DataType(&#123;ge::DT_FLOAT16&#125;)</span><br><span class="line"> .Format(&#123;ge::FORMAT_ND&#125;)</span><br><span class="line"> .UnknownShapeFormat(&#123;ge::FORMAT_ND&#125;);</span><br><span class="line"> this-&gt;SetInferShape(ge::InferShape);</span><br><span class="line"> this-&gt;AICore()</span><br><span class="line"> .SetTiling(optiling::TilingFunc);</span><br><span class="line"> this-&gt;AICore().AddConfig(<span class="string">&quot;ascend310b&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;;</span><br><span class="line">OP_ADD(SinhCustom);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>认证成功！</strong></p>
<div align=center>
    <img src="https://i-blog.csdnimg.cn/direct/b40d1557f2a04714ab2ac31adba789d8.jpeg">
</div>


<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>训练营时间不长但收获满满，同时认识到自己有很多不足，希望勤能补拙！</p>
</div><div class="post-end"><div class="post-prev"><a href="/2024/07/27/%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80-%E4%BA%92%E8%81%94%E7%BD%91%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86/" title="上一篇文章"><i class="fa-solid fa-chevron-left fa-lg"></i></a></div><div class="post-reward" onclick="openPostReward()" title="赞赏"><i class="fa-regular fa-thumbs-up fa-xl fa-beat-fade"></i></div><div id="reward-panel" onclick="closePostReward()"><div class="reward-container"><p>很荣幸您喜欢这篇文章，欢迎再来，谢谢&#128151;</p>
<div class="reward-nav"><div class="reward-item"><img class="reward-img" src="/img/reward/wechat.jpg" title="Wechat" alt="Wechat"/><span>Wechat</span></div><div class="reward-item"><img class="reward-img" src="/img/reward/alipay.jpg" title="Alipay" alt="Alipay"/><span>Alipay</span></div></div></div></div><div class="post-next"><a href="/2024/07/25/%E5%89%8D%E7%AB%AF%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95-%E7%AE%80%E7%BA%A6%E5%94%AF%E7%BE%8E%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2/" title="下一篇文章"><i class="fa-solid fa-chevron-right fa-lg"></i></a></div></div></article><div id="post-toc"><aside class="toc-aside"><div class="toc-title"><span><i class="fa-solid fa-paw"></i>目录</span></div><div class="toc-container"><ol class="toc-content"><li class="toc-content-item toc-content-level-1"><a class="toc-content-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-content-number">1.</span> <span class="toc-content-text">前言</span></a></li><li class="toc-content-item toc-content-level-1"><a class="toc-content-link" href="#%E4%B8%80%E3%80%81%E8%83%8C%E6%99%AF%E7%9F%A5%E8%AF%86"><span class="toc-content-number">2.</span> <span class="toc-content-text">一、背景知识</span></a><ol class="toc-content-child"><li class="toc-content-item toc-content-level-2"><a class="toc-content-link" href="#1-CANN-AI-core"><span class="toc-content-number">2.1.</span> <span class="toc-content-text">1. CANN&amp;AI core</span></a></li><li class="toc-content-item toc-content-level-2"><a class="toc-content-link" href="#2-Ascend-C%E7%AE%97%E5%AD%90"><span class="toc-content-number">2.2.</span> <span class="toc-content-text">2. Ascend C算子</span></a></li><li class="toc-content-item toc-content-level-2"><a class="toc-content-link" href="#3-%E6%A0%B8%E5%87%BD%E6%95%B0"><span class="toc-content-number">2.3.</span> <span class="toc-content-text">3. 核函数</span></a></li></ol></li><li class="toc-content-item toc-content-level-1"><a class="toc-content-link" href="#%E4%BA%8C%E3%80%81%E7%BC%96%E7%A8%8B%E8%8C%83%E5%BC%8F"><span class="toc-content-number">3.</span> <span class="toc-content-text">二、编程范式</span></a></li><li class="toc-content-item toc-content-level-1"><a class="toc-content-link" href="#%E4%B8%89%E3%80%81%E9%A6%99%E6%A9%99%E6%B4%BE%E7%9A%84%E8%BF%9E%E6%8E%A5"><span class="toc-content-number">4.</span> <span class="toc-content-text">三、香橙派的连接</span></a></li><li class="toc-content-item toc-content-level-1"><a class="toc-content-link" href="#%E5%9B%9B%E3%80%81%E6%94%B9%E9%80%A0sinh%E4%BB%BB%E5%8A%A1"><span class="toc-content-number">5.</span> <span class="toc-content-text">四、改造sinh任务</span></a><ol class="toc-content-child"><li class="toc-content-item toc-content-level-2"><a class="toc-content-link" href="#1-%E6%B5%8B%E8%AF%95%E8%BF%90%E8%A1%8C"><span class="toc-content-number">5.1.</span> <span class="toc-content-text">1.测试运行</span></a></li><li class="toc-content-item toc-content-level-2"><a class="toc-content-link" href="#2-%E6%94%B9%E9%80%A0%E6%88%90sinh"><span class="toc-content-number">5.2.</span> <span class="toc-content-text">2.改造成sinh</span></a></li></ol></li><li class="toc-content-item toc-content-level-1"><a class="toc-content-link" href="#%E4%BA%94%E3%80%81Ascend-C%E4%B8%AD%E7%BA%A7%E8%AE%A4%E8%AF%81"><span class="toc-content-number">6.</span> <span class="toc-content-text">五、Ascend C中级认证</span></a></li><li class="toc-content-item toc-content-level-1"><a class="toc-content-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-content-number">7.</span> <span class="toc-content-text">总结</span></a></li></ol></div></aside><div class="toc-blank" onclick="tocToggle()"></div></div></div></div><div id="tool-bar"><div id="tool-toggle" onclick="toolToggle()" title="设置"><i class="fa-solid fa-gear"></i></div><div id="toc-toggle" onclick="tocToggle()" title="目录"><i class="fa-solid fa-list-ul"></i></div><div id="back-to-top" onclick="scrollToTop()" title="返回顶部"><i class="fa-solid fa-chevron-up"></i></div></div><div id="search-panel"><div class="search-container"><div class="search-head"><div class="search-title"><span><i class="fa-solid fa-paw"></i>搜索</span></div><div class="search-close-btn" onclick="toggleSearchWindow()"><i class="fa-regular fa-circle-xmark"></i></div></div><div class="search-box"><i class="fa-solid fa-magnifying-glass"></i><input id="search-input" type="text" placeholder="请输入需要搜索的内容……" value=""/></div><div class="search-body"><div id="search-count">匹配结果数: </div><div id="search-result"></div><div id="search-result-empty">未搜索到匹配的文章。</div></div></div></div><footer><div class="footer-content"><div class="copyright-info"><i class="fa-regular fa-copyright fa-xs"></i><span>2024</span><a href="/about">kiyoumiii</a><i class="fa-solid fa-cat fa-sm"></i><span>Powered by</span><a href="https://hexo.io/" target="_blank">Hexo</a><span> &amp;</span><a href="https://github.com/chanwj/hexo-theme-meow" target="_blank" title="v1.0.0">Theme Meow</a></div><div class="pageview-site"><span id="busuanzi_container_site_pv">总访问量 : <span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner"></i></span></span><span id="busuanzi_container_site_uv">总访客数 : <span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner"></i></span></span></div></div></footer>

<script src="/js/theme/tool-bar.js"></script>


<script src="/js/theme/menu.js"></script>

<script src="/js/theme/reward.js"></script>

<script src="/js/jquery-3.7.1.min.js"></script>


<script src="/js/theme/search.js"></script>
<script>var search_path = 'search.xml';
if (search_path.length == 0) {
  search_path = "search.xml";
}
var path = '/' + search_path;
searchFunc(path, 'search-input', 'search-result');</script></body></html>